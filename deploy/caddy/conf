logging:
  logs:
    default:
      level: INFO
storage:
  "module": "file_system"
  "root": "/data"
apps:
  tls:
    certificates:
      automate:
        - vocespace.xyz
        - turn.vocespace.xyz
        - server.vocespace.xyz
  layer4:
    servers:
      main:
        listen: [":443"]
        routes:

          # TURN æœåŠ¡
          - match:
              - tls:
                  sni:
                    - "turn.vocespace.xyz"
            handle:
              - handler: tls
              - handler: proxy
                upstreams:
                  - dial: ["localhost:5349"]
          # ğŸ’¡ LiveKit æœåŠ¡ï¼Œé€šè¿‡ server.vocespace.xyz
          - match:
              - tls:
                  sni:
                    - "server.vocespace.xyz"
            handle:
              - handler: tls
              - handler: proxy
                upstreams:
                  - dial: ["localhost:7880"]

          # ğŸ’¡ å‰ç«¯æœåŠ¡ï¼Œé€šè¿‡ vocespace.xyz
          - match:
              - tls:
                  sni:
                    - "vocespace.xyz"
            handle:
              - handler: tls
                connection_policies:
                  - alpn: ["http/1.1"]
              - handler: proxy
                upstreams:
                  - dial: ["localhost:3000"]


caddy run --config caddy.yaml --adapter yaml



space.voce.chat {
    # é»˜è®¤å¯ç”¨ HTTPS
    
    # ä¸»åº”ç”¨ä»£ç†
    handle / {
        reverse_proxy 127.0.0.1:3000 {
            header_up Host {host}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
        }
    }

    # WebRTC ä»£ç†
    handle /rtc/* {
        reverse_proxy 127.0.0.1:7880 {
            header_up Host {host}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
        }
    }

    # å¯ç”¨ HTTP/1.1
    protocols http/1.1
}

vocespace.xyz {
    # é»˜è®¤å¯ç”¨ HTTPS
    
    # WebRTC/LiveKit ä»£ç† - éœ€è¦æ”¾åœ¨æ›´å…·ä½“çš„è·¯å¾„å‰é¢
    handle /rooms/* {
        reverse_proxy localhost:7880 {
            header_up Host {host}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }


    # ä¸»åº”ç”¨ä»£ç† - æ”¾åœ¨æœ€åä½œä¸ºé»˜è®¤å¤„ç†
    handle /* {
        reverse_proxy localhost:3000 {
            header_up Host {host}
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }

    # å¯ç”¨æ—¥å¿—ä»¥ä¾¿è°ƒè¯•
    log {
        output file /var/log/caddy/vocespace.xyz.log
        level DEBUG
    }
}